<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>الاستعلام عن درجه الطالب</title>

    <!-- Import Cairo Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* Modern Reset & Variables */
        :root {
            --primary-bg: #0f172a;
            --accent-color: #fbbf24;
            --accent-hover: #d97706;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: #f1f5f9;
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--primary-bg);
            color: var(--text-color);
        }

        /* 1. Animated Gradient Background */
        .fixed-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(-45deg, #0f172a, #1e3a8a, #312e81, #0f172a);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            z-index: 1;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Floating Circles */
        .circles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .circles div {
            position: absolute;
            display: block;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            animation: float 25s linear infinite;
            bottom: -150px;
            border-radius: 50%;
        }

        .circles div:nth-child(1) {
            left: 25%;
            width: 80px;
            height: 80px;
            animation-delay: 0s;
        }

        .circles div:nth-child(2) {
            left: 10%;
            width: 20px;
            height: 20px;
            animation-delay: 2s;
            animation-duration: 12s;
        }

        .circles div:nth-child(3) {
            left: 70%;
            width: 20px;
            height: 20px;
            animation-delay: 4s;
        }

        .circles div:nth-child(4) {
            left: 40%;
            width: 60px;
            height: 60px;
            animation-delay: 0s;
            animation-duration: 18s;
        }

        .circles div:nth-child(5) {
            left: 65%;
            width: 20px;
            height: 20px;
            animation-delay: 0s;
        }

        .circles div:nth-child(6) {
            left: 75%;
            width: 110px;
            height: 110px;
            animation-delay: 3s;
        }

        .circles div:nth-child(7) {
            left: 35%;
            width: 150px;
            height: 150px;
            animation-delay: 7s;
        }

        .circles div:nth-child(8) {
            left: 50%;
            width: 25px;
            height: 25px;
            animation-delay: 15s;
            animation-duration: 45s;
        }

        .circles div:nth-child(9) {
            left: 20%;
            width: 15px;
            height: 15px;
            animation-delay: 2s;
            animation-duration: 35s;
        }

        .circles div:nth-child(10) {
            left: 85%;
            width: 150px;
            height: 150px;
            animation-delay: 0s;
            animation-duration: 11s;
        }

        @keyframes float {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
                border-radius: 0;
            }

            100% {
                transform: translateY(-1000px) rotate(720deg);
                opacity: 0;
                border-radius: 50%;
            }
        }

        /* Layout & Scrolling */
        .content-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Allow content to start from top on small screens, center on large */
            justify-content: center;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 2;
            padding: 20px;
            /* Padding for Footer to not overlap content */
            padding-bottom: 80px;
        }

        /* Flex alignment fix for scrollable content */
        .content-wrapper::before,
        .content-wrapper::after {
            content: '';
            flex: 0 0 auto;
            /* Push content to center if small, allow scroll if big */
        }

        /* Glass Cards */
        .card {
            width: 100%;
            max-width: 450px;
            background: var(--glass-bg);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            box-shadow: var(--card-shadow);
            text-align: center;
            animation: slideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            margin: auto;
            /* Vertically center */
            flex-shrink: 0;
        }

        #resultCard {
            max-width: 100%;
            /* Make it almost full width on big screens */
            width: 100%;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            width: 100px;
            margin-bottom: 1rem;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
        }

        h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(to right, #fff, #cbd5e1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Form Elements */
        input,
        select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.2);
            color: #fff;
            font-size: 1rem;
            margin-bottom: 1rem;
            outline: none;
            transition: 0.3s;
        }

        input:focus,
        select:focus {
            background: rgba(0, 0, 0, 0.3);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.2);
        }

        /* Custom Select Arrow */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 1rem center;
            background-size: 1em;
        }

        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: #111;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        /* Shine Effect for Button */
        button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        button:hover::after {
            left: 100%;
            transition: 0.7s;
        }

        button:hover {
            box-shadow: 0 6px 20px rgba(251, 191, 36, 0.5);
            transform: translateY(-2px);
        }

        button:active {
            transform: scale(0.98);
        }

        /* Input Focus Glow */
        input:focus,
        select:focus {
            background: rgba(0, 0, 0, 0.3);
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.4);
        }

        /* Shake Animation for Invalid Input */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
                border-color: #f87171;
            }

            50% {
                transform: translateX(5px);
                border-color: #f87171;
            }

            75% {
                transform: translateX(-5px);
                border-color: #f87171;
            }
        }

        .shake-animation {
            animation: shake 0.3s ease-in-out;
            border-color: #f87171 !important;
        }

        .result {
            margin-top: 1rem;
            padding: 0.5rem;
            /* Remove box style */
            background: transparent;
            border: none;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .result:empty {
            display: none;
            margin: 0;
            padding: 0;
        }

        /* Result Tables & Responsive Code */
        /* Updated Student Info (Unified Box Style) */
        .student-info {
            display: grid;
            grid-template-columns: repeat(4, 1fr) !important;
            /* FORCE 4 Columns always */
            gap: 1px;
            /* Small gap for internal borders */
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.1);
            /* Border color between items */
            padding: 1px;
            /* Border width */
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.15);
            min-width: 800px;
            /* Force it WIDE so it scrolls, never wraps */
            width: max-content;
            /* Ensure it takes up space */
        }

        .info-group {
            background: rgba(0, 0, 0, 0.3);
            /* Item background */
            /* border removed */
            /* border-radius removed */
            display: flex;
            flex-direction: column;
            width: auto;
            /* Allow natural width */
        }

        .info-label {
            background: #00897b;
            color: #fff;
            padding: 8px 10px;
            font-size: 0.95rem;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
        }

        .info-value {
            padding: 10px;
            text-align: center;
            font-size: 1.1rem;
            color: #fff;
            font-weight: 600;
            background: rgba(0, 0, 0, 0.2);
            /* Slightly darker for contrast */
            white-space: nowrap;
            /* Keep values on one line */
        }

        /* Responsive: Stack on mobile */
        @media screen and (max-width: 600px) {
            .student-info {
                grid-template-columns: 1fr;
            }
        }

        /* Responsive Table */
        .table-container {
            width: 100%;
            overflow: hidden;
            /* Manage overflow manually */
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: #fff;
        }

        th,
        td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 1rem;
        }

        th {
            background: #00897b;
            /* Teal */
            color: #fff;
            font-weight: 700;
        }

        .student-score {
            font-weight: bold;
            color: var(--accent-color);
        }

        .total-row {
            background: rgba(251, 191, 36, 0.1);
            font-weight: bold;
        }

        .total-row td {
            color: var(--accent-color);
            font-size: 1.1rem;
        }

        /* Updated Table Stylings for Transposed View */
        /* Updated Table Stylings for Transposed View */
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-top: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding-bottom: 5px;

            /* Hide Scrollbar Globally by default */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE/Edge */
        }

        /* Hide Scrollbar Chrome/Safari/Webkit */
        .table-container::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            /* Fit screen on desktop and big screens */
            min-width: 100%;
        }

        th,
        td {
            padding: 10px 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.95rem;
            white-space: nowrap;
            /* Prevent wrapping generally for clean look */
        }

        /* Sticky Columns Removed */
        th:first-child,
        td:first-child {
            position: static;
            background: #00897b;
            color: #fff;
            font-weight: bold;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: none;
        }

        thead tr:first-child th {
            background: #00897b;
            color: #fff;
        }

        thead tr:nth-child(2) th {
            background: #00695c;
            color: #fff;
        }

        /* Total Column Styling */
        .total-col {
            background-color: #d32f2f !important;
            color: white !important;
            font-weight: bold;
        }

        .total-header {
            background-color: #c62828 !important;
            color: white !important;
        }

        tbody tr:nth-child(odd) td:not(:first-child) {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Mobile Responsive View - Full Page Swipe */
        /* Mobile Responsive View - Optimized Scroll & Centered */
        @media screen and (max-width: 768px) {

            .content-wrapper {
                padding: 10px;
                padding-top: 40px;
                padding-bottom: 120px;
                display: block;
                overflow-x: auto;
                overflow-y: auto;
                height: 100vh;
                box-sizing: border-box;
                text-align: center;
                /* Center layouts */
            }

            /* Search Card: Centered */
            #searchCard {
                width: 90%;
                max-width: 400px;
                margin: 0 auto;
                /* Centering */
                display: inline-block;
                /* Keeps it respecting text-align if needed, or block with auto margin */
                white-space: normal;
                /* Internal text center */
                text-align: center;
                vertical-align: top;
            }

            /* Result Card: Block with auto margin for safe centering */
            #resultCard {
                display: block;
                /* Works best with text-align: right parent */
                width: max-content;
                /* Key fix: border wraps ALL content */
                min-width: 100%;
                /* At least screen width */
                max-width: none;
                /* Allow infinite growth */
                margin: 0 auto;
                /* Center if possible */
                padding: 15px;
                white-space: normal;
                direction: rtl;
                box-sizing: border-box;
            }

            .table-container {
                width: 100%;
                overflow: visible;
                flex: 1;
                /* Take space */
            }

            table {
                width: 100%;
                /* min-width removed, let container dictate or content dictate */
            }

            th,
            td {
                padding: 12px;
                font-size: 1rem;
                white-space: nowrap;
                /* Keep rows single line => Forces Width */
            }

            /* Hide scrollbars */
            ::-webkit-scrollbar {
                display: none;
            }

            * {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }

        /* Back Button */
        .back-btn {
            display: inline-block;
            margin-top: 1.5rem;
            padding: 12px 40px;
            background: transparent;
            color: #fff;
            text-decoration: none;
            cursor: pointer;
            border-radius: 25px;
            font-weight: bold;
            transition: 0.3s;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .back-btn:hover {
            background: #fff;
            color: #000;
            border-color: #fff;
        }

        .hidden {
            display: none !important;
        }

        /* Footer */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            text-align: center;
            padding: 10px 0;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        @media (max-width: 480px) {
            .content-wrapper {
                justify-content: flex-start;
                /* Ensure top alignment on mobile scroll */
                padding-top: 40px;
            }

            h2 {
                font-size: 1.3rem;
            }

            .card {
                padding: 20px;
            }
        }

        .logo {
            margin: 0px;
            border-radius: 50%;
            padding: 0px;
        }
    </style>
</head>

<body>

    <!-- Animated Background -->
    <div class="fixed-background">
        <div class="circles">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content-wrapper">

        <!-- Search Card -->
        <div id="searchCard" class="card">
            <a href="https://ibb.co/cKc5Pm4R" target="_blank">
                <img class="logo" src="https://i.ibb.co/ZR6s3Zqv/457615888-933036922172497-1073708694902476499-n.jpg"
                    alt="لوجو المدرسة">
            </a>
            <h2 style="margin: 0px; padding: 0px;">البحث عن النتيجة</h2>
            <select id="stage" onchange="updateGrades()">
                <option value="" disabled selected>اختر المرحلة</option>
                <option value="primary">الابتدائية</option>
                <option value="preparatory">الاعدادية</option>
                <option value="secondary">الثانوية</option>
            </select>
            <select id="grade">
                <option value="" disabled selected>اختر الصف</option>
            </select>
            <input id="nid" type="text" placeholder="ادخل الرقم القومي" maxlength="14" minlength="14">
            <button onclick="searchNow()">بحث</button>
            <div id="result" class="result"></div>
        </div>

        <!-- Result Card -->
        <div id="resultCard" class="card hidden">


            <div class="student-info">
                <div class="info-group">
                    <div class="info-label">اسم الطالب</div>
                    <div class="info-value">محمد أحمد محمود</div>
                </div>
                <div class="info-group">
                    <div class="info-label">الرقم القومي</div>
                    <div class="info-value" id="student-nid"></div>
                </div>
                <div class="info-group">
                    <div class="info-label">الصف</div>
                    <div class="info-value" id="resGrade"></div>
                </div>
                <div class="info-group">
                    <div class="info-label">المدرسة</div>
                    <div class="info-value">الشهيد عمرو شهاب</div>
                </div>
            </div>

            <div class="table-container">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>المادة</th>
                            <th>العظمى</th>
                            <th>الصغرى</th>
                            <th>الدرجة</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <!-- Dynamic Content -->
                    </tbody>
                </table>
            </div>

            <!-- Back Button Removed -->
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // MOCK SHIM FOR LOCAL DEVELOPMENT
        if (typeof google === 'undefined') {
            console.warn("Running in local mode - Mocking google.script.run");
            window.google = {
                script: {
                    run: {
                        withSuccessHandler: function (successCallback) {
                            return {
                                withFailureHandler: function (failureCallback) {
                                    return {
                                        getStudentData: function (stage, grade, nid) {
                                            console.log(`Mocking Backend Call: ${stage}, ${grade}, ${nid}`);

                                            // Simulate network delay
                                            setTimeout(() => {
                                                // --- DUPLICATE LOGIC FROM code.js FOR LOCAL TESTING ---
                                                if (!nid || nid.length < 14) {
                                                    // This path is technically blocked by frontend validation, but just in case
                                                    if (failureCallback) failureCallback("Error: Invalid ID");
                                                    return;
                                                }

                                                // Helper rng
                                                function score(min, max) { return (Math.random() * (max - min) + min).toFixed(1).replace('.0', ''); }

                                                var mockScores = {};
                                                // Basic Mocking Logic using existing frontend data structure to be consistent
                                                // We can access 'subjectsData' because this is running in the window context
                                                if (subjectsData[stage] && subjectsData[stage][grade]) {
                                                    let core = subjectsData[stage][grade].core || [];
                                                    let nonCore = subjectsData[stage][grade].nonCore || [];

                                                    core.forEach(s => mockScores[s.name] = score(s.min, s.max));
                                                    nonCore.forEach(s => mockScores[s.name] = score(s.min, s.max));
                                                }

                                                var response = {
                                                    status: "success",
                                                    studentName: "محمد أحمد محمود (محاكاة)",
                                                    schoolName: "الشهيد عمرو شهاب",
                                                    nid: nid,
                                                    grade: grade,
                                                    stage: stage,
                                                    scores: mockScores
                                                };

                                                successCallback(response);
                                            }, 1000);
                                        }
                                    }
                                },
                                getStudentData: function (stage, grade, nid) {
                                    // Fallback if no failure handler chain
                                    this.withSuccessHandler(successCallback).withFailureHandler(() => { }).getStudentData(stage, grade, nid);
                                }
                            }
                        }
                    }
                }
            };
        }

        const gradesList = {
            primary: [
                "الاول الابتدائي", "الثاني الابتدائي", "الثالث الابتدائي",
                "الرابع الابتدائي", "الخامس الابتدائي", "السادس الابتدائي"
            ],
            preparatory: [
                "الاول الاعدادي", "الثاني الاعدادي", "الثالث الاعدادي"
            ],
            secondary: [
                "الاول الثانوي",
                "الثاني الثانوي",
                "الثالث الثانوي"
            ]
        };

        function updateGrades() {
            const stage = document.getElementById('stage').value;
            const gradeSelect = document.getElementById('grade');
            gradeSelect.innerHTML = '<option value="" disabled selected>اختر الصف</option>';

            if (gradesList[stage]) {
                gradesList[stage].forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g;
                    opt.textContent = g;
                    gradeSelect.appendChild(opt);
                });
            }
        }

        const subjectsData = {
            primary: {
                "الاول الابتدائي": {
                    core: [
                        { name: "لغة عربية", max: 100, min: 50 },
                        { name: "رياضيات", max: 80, min: 40 },
                        { name: "لغة إنجليزية", max: 60, min: 30 },
                        { name: "علوم", max: 40, min: 20 },
                        { name: "دراسات", max: 40, min: 20 }
                    ],
                    nonCore: [
                        { name: "تربية دينية", max: 40, min: 20 },
                        { name: "تكنولوجيا", max: 20, min: 10 },
                        { name: "كت", max: 20, min: 10 }
                    ]
                },
                "الثاني الابتدائي": {
                    core: [
                        { name: "لغة عربية", max: 100, min: 50 },
                        { name: "رياضيات", max: 80, min: 40 },
                        { name: "لغة إنجليزية", max: 60, min: 30 },
                        { name: "علوم", max: 40, min: 20 },
                        { name: "دراسات", max: 40, min: 20 }
                    ],
                    nonCore: [
                        { name: "تربية دينية", max: 40, min: 20 },
                        { name: "تكنولوجيا", max: 20, min: 10 },
                        { name: "كت", max: 20, min: 10 }
                    ]
                },
                "الثالث الابتدائي": {
                    core: [
                        { name: "لغة عربية", max: 100, min: 50 },
                        { name: "رياضيات", max: 80, min: 40 },
                        { name: "لغة إنجليزية", max: 60, min: 30 },
                        { name: "علوم", max: 40, min: 20 },
                        { name: "دراسات", max: 40, min: 20 }
                    ],
                    nonCore: [
                        { name: "تربية دينية", max: 40, min: 20 },
                        { name: "تكنولوجيا", max: 20, min: 10 },
                        { name: "كت", max: 20, min: 10 }
                    ]
                },
                "الرابع الابتدائي": {
                    core: [
                        { name: "لغة عربية", max: 100, min: 50 },
                        { name: "رياضيات", max: 80, min: 40 },
                        { name: "لغة إنجليزية", max: 60, min: 30 },
                        { name: "علوم", max: 40, min: 20 },
                        { name: "دراسات", max: 40, min: 20 }
                    ],
                    nonCore: [
                        { name: "تربية دينية", max: 40, min: 20 },
                        { name: "تكنولوجيا", max: 20, min: 10 },
                        { name: "كت", max: 20, min: 10 }
                    ]
                },
                "الخامس الابتدائي": {
                    core: [
                        { name: "لغة عربية", max: 100, min: 50 },
                        { name: "رياضيات", max: 80, min: 40 },
                        { name: "لغة إنجليزية", max: 60, min: 30 },
                        { name: "علوم", max: 40, min: 20 },
                        { name: "دراسات", max: 40, min: 20 }
                    ],
                    nonCore: [
                        { name: "تربية دينية", max: 40, min: 20 },
                        { name: "تكنولوجيا", max: 20, min: 10 },
                        { name: "كت", max: 20, min: 10 }
                    ]
                },
                "السادس الابتدائي": {
                    core: [
                        { name: "لغة عربية", max: 100, min: 50 },
                        { name: "رياضيات", max: 80, min: 40 },
                        { name: "لغة إنجليزية", max: 60, min: 30 },
                        { name: "علوم", max: 40, min: 20 },
                        { name: "دراسات", max: 40, min: 20 }
                    ],
                    nonCore: [
                        { name: "تربية دينية", max: 40, min: 20 },
                        { name: "تكنولوجيا", max: 20, min: 10 },
                        { name: "كت", max: 20, min: 10 }
                    ]
                }
            },
            preparatory: {
                "الاول الاعدادي": {
                    core: [
                        { name: "عربي", max: 40, min: 20 },
                        { name: "انجليزي", max: 30, min: 15 },
                        { name: "دراسات", max: 20, min: 10 },
                        { name: "جبر", max: 15, min: 7.5 },
                        { name: "هندسة", max: 15, min: 7.5 },
                        { name: "علوم", max: 20, min: 10 }
                    ],
                    nonCore: [
                        { name: "تربية فنية", max: 10, min: 5 },
                        { name: "حاسب آلي", max: 10, min: 5 },
                        { name: "تربية دينية", max: 20, min: 10 },
                        { name: "مستوى 1", max: 25, min: 12.5 },
                        { name: "مستوى 2", max: 20, min: 10 }
                    ]
                },
                "الثاني الاعدادي": {
                    core: [
                        { name: "عربي", max: 40, min: 20 },
                        { name: "انجليزي", max: 30, min: 15 },
                        { name: "دراسات", max: 20, min: 10 },
                        { name: "جبر", max: 15, min: 7.5 },
                        { name: "هندسة", max: 15, min: 7.5 },
                        { name: "علوم", max: 20, min: 10 }
                    ],
                    nonCore: [
                        { name: "تربية فنية", max: 10, min: 5 },
                        { name: "حاسب آلي", max: 10, min: 5 },
                        { name: "تربية دينية", max: 20, min: 10 },
                        { name: "مستوى 1", max: 25, min: 12.5 },
                        { name: "مستوى 2", max: 20, min: 10 }
                    ]
                },
                "الثالث الاعدادي": {
                    core: [
                        { name: "عربي", max: 40, min: 20 },
                        { name: "انجليزي", max: 30, min: 15 },
                        { name: "دراسات", max: 20, min: 10 },
                        { name: "جبر", max: 15, min: 7.5 },
                        { name: "هندسة", max: 15, min: 7.5 },
                        { name: "علوم", max: 20, min: 10 }
                    ],
                    nonCore: [
                        { name: "تربية فنية", max: 10, min: 5 },
                        { name: "حاسب آلي", max: 10, min: 5 },
                        { name: "تربية دينية", max: 20, min: 10 },
                        { name: "مستوى 1", max: 25, min: 12.5 },
                        { name: "مستوى 2", max: 20, min: 10 }
                    ]
                }
            },
            secondary: {
                "الاول الثانوي": {
                    core: [
                        { name: "لغة عربية", max: 50, min: 25 },
                        { name: "أجنبية 1", max: 50, min: 25 },
                        { name: "أجنبية 2", max: 40, min: 20 },
                        { name: "بحتة", max: 60, min: 30 },
                        { name: "تطبيقية", max: 60, min: 30 },
                        { name: "فيزياء", max: 60, min: 30 },
                        { name: "كيمياء", max: 60, min: 30 }
                    ],
                    nonCore: [
                        { name: "تربية دينية", max: 20, min: 10 },
                        { name: "تربية وطنية", max: 20, min: 10 }
                    ]
                },
                "الثاني الثانوي": {
                    core: [
                        { name: "لغة عربية", max: 50, min: 25 },
                        { name: "أجنبية 1", max: 50, min: 25 },
                        { name: "أجنبية 2", max: 40, min: 20 },
                        { name: "بحتة", max: 60, min: 30 },
                        { name: "تطبيقية", max: 60, min: 30 },
                        { name: "فيزياء", max: 60, min: 30 },
                        { name: "كيمياء", max: 60, min: 30 }
                    ],
                    nonCore: [
                        { name: "تربية دينية", max: 20, min: 10 },
                        { name: "تربية وطنية", max: 20, min: 10 }
                    ]
                },
                "الثالث الثانوي": {
                    core: [
                        { name: "لغة عربية", max: 50, min: 25 },
                        { name: "أجنبية 1", max: 50, min: 25 },
                        { name: "أجنبية 2", max: 40, min: 20 },
                        { name: "بحتة", max: 60, min: 30 },
                        { name: "تطبيقية", max: 60, min: 30 },
                        { name: "فيزياء", max: 60, min: 30 },
                        { name: "كيمياء", max: 60, min: 30 }
                    ],
                    nonCore: [
                        { name: "تربية دينية", max: 20, min: 10 },
                        { name: "تربية وطنية", max: 20, min: 10 }
                    ]
                }
            }
        };

        /* generateRandomScore removed */

        function renderResultTable(stage, grade, studentData) {
            const table = document.getElementById('resultsTable');
            table.innerHTML = '';

            // Normalize data access
            let data = (subjectsData[stage] && subjectsData[stage][grade]) ? subjectsData[stage][grade] : { core: [], nonCore: [] };
            if (!subjectsData[stage]) {
                console.warn('Stage data not found:', stage);
            } else if (!subjectsData[stage][grade]) {
                console.warn('Grade data not found within stage:', stage, grade);
            }

            // Safety check for core/nonCore existence
            const coreSubjects = data.core || [];
            const nonCoreSubjects = data.nonCore || [];

            // Calculate Totals per subject (and Grand Total)
            let totalMax = 0;
            let totalMin = 0;
            let totalScore = 0;

            // Map scores from backend data
            // Expecting studentData.scores to be { "Arabic": 50, ... }
            const incomingScores = studentData.scores || {};

            const coreScores = coreSubjects.map(sub => {
                let rawVal = incomingScores[sub.name];
                // Handle missing or invalid
                let s = parseFloat(rawVal);
                if (isNaN(s)) s = 0;

                totalMax += sub.max;
                totalMin += sub.min;
                totalScore += s;
                return s;
            });

            const nonCoreScores = nonCoreSubjects.map(sub => {
                let rawVal = incomingScores[sub.name];
                let s = parseFloat(rawVal);
                if (isNaN(s)) s = 0; // Or handle as empty
                return s;
            });

            // --- Build Header ---
            const thead = table.createTHead();

            // Row 1: Group Headers
            const tr1 = thead.insertRow();

            // "Right" Labels Group (Core) + Label
            const thCoreGroup = document.createElement('th');
            thCoreGroup.textContent = "مواد تضاف الى المجموع الكلي";
            thCoreGroup.colSpan = coreSubjects.length + 1; // +1 for the Row Label column
            thCoreGroup.style.background = "#00897b";
            thCoreGroup.style.color = "#fff";
            tr1.appendChild(thCoreGroup);

            // "Middle" Total
            const thTotalGroup = document.createElement('th');
            thTotalGroup.textContent = "المجموع";
            thTotalGroup.rowSpan = 2;
            thTotalGroup.className = "total-header"; // Red
            tr1.appendChild(thTotalGroup);

            // "Left" Non-Core Group
            if (nonCoreSubjects.length > 0) {
                const thNonCoreGroup = document.createElement('th');
                thNonCoreGroup.textContent = "مواد لاتضاف الى المجموع الكلي";
                thNonCoreGroup.colSpan = nonCoreSubjects.length;
                thNonCoreGroup.style.background = "#00897b";
                thNonCoreGroup.style.color = "#fff";
                tr1.appendChild(thNonCoreGroup);
            }

            // Row 2: specific subjects
            const tr2 = thead.insertRow();

            // The "Matrix Label" (المادة)
            const thLabel = document.createElement('th');
            thLabel.textContent = "المادة";
            tr2.appendChild(thLabel);

            // Core Names
            coreSubjects.forEach(sub => {
                const th = document.createElement('th');
                th.textContent = sub.name;
                tr2.appendChild(th);
            });

            // Non-Core Names
            nonCoreSubjects.forEach(sub => {
                const th = document.createElement('th');
                th.textContent = sub.name;
                tr2.appendChild(th);
            });


            // --- Build Body ---
            const tbody = table.createTBody();

            // Row Max
            const trMax = tbody.insertRow();
            const tdMaxL = document.createElement('td'); tdMaxL.textContent = "الكبرى"; tdMaxL.style.background = '#00897b'; tdMaxL.style.color = '#fff'; tdMaxL.style.fontWeight = 'bold'; trMax.appendChild(tdMaxL);
            coreSubjects.forEach(s => { const td = document.createElement('td'); td.textContent = s.max; trMax.appendChild(td); });
            const tdTvM = document.createElement('td'); tdTvM.className = 'total-col'; tdTvM.textContent = totalMax; trMax.appendChild(tdTvM);
            nonCoreSubjects.forEach(s => { const td = document.createElement('td'); td.textContent = s.max; trMax.appendChild(td); });

            // Row Min
            const trMin = tbody.insertRow();
            const tdMinL = document.createElement('td'); tdMinL.textContent = "الصغرى"; tdMinL.style.background = '#00897b'; tdMinL.style.color = '#fff'; tdMinL.style.fontWeight = 'bold'; trMin.appendChild(tdMinL);
            coreSubjects.forEach(s => { const td = document.createElement('td'); td.textContent = s.min; trMin.appendChild(td); });
            const tdTvMin = document.createElement('td'); tdTvMin.className = 'total-col'; tdTvMin.textContent = totalMin; trMin.appendChild(tdTvMin);
            nonCoreSubjects.forEach(s => { const td = document.createElement('td'); td.textContent = s.min; trMin.appendChild(td); });

            // Row Grade
            const trG = tbody.insertRow();
            const tdGL = document.createElement('td'); tdGL.textContent = "الدرجة"; tdGL.style.background = '#00897b'; tdGL.style.color = '#fff'; tdGL.style.fontWeight = 'bold'; trG.appendChild(tdGL);
            coreScores.forEach(s => { const td = document.createElement('td'); td.textContent = s; td.className = 'student-score'; trG.appendChild(td); });
            const tdTvG = document.createElement('td'); tdTvG.className = 'total-col'; tdTvG.textContent = totalScore.toFixed(1).replace('.0', ''); trG.appendChild(tdTvG);
            nonCoreScores.forEach(s => { const td = document.createElement('td'); td.textContent = s; td.className = 'student-score'; trG.appendChild(td); });
        }

        function searchNow() {
            let idInput = document.getElementById('nid');
            let id = idInput.value.trim();
            let stageSelect = document.getElementById('stage');
            let gradeSelect = document.getElementById('grade');

            // Validate Inputs
            let isValid = true;
            // Reset Validation
            idInput.style.borderColor = "rgba(255, 255, 255, 0.1)";
            idInput.classList.remove('shake-animation');
            gradeSelect.style.borderColor = "rgba(255, 255, 255, 0.1)";
            gradeSelect.classList.remove('shake-animation');

            if (id === '' || id.length !== 14) {
                idInput.style.borderColor = "#f87171";
                idInput.classList.add('shake-animation');
                isValid = false;
            }
            if (gradeSelect.value === '') {
                gradeSelect.style.borderColor = "#f87171";
                gradeSelect.classList.add('shake-animation');
                isValid = false;
            }

            if (!isValid) {
                setTimeout(() => {
                    idInput.classList.remove('shake-animation');
                    gradeSelect.classList.remove('shake-animation');
                }, 500);
                return;
            }

            // Show loading
            let r = document.getElementById('result');
            r.style.display = 'block';
            r.innerHTML = '<span style="color:var(--accent-color)">جارِ البحث...</span>';

            // CALL BACKEND
            google.script.run
                .withSuccessHandler(onSearchSuccess)
                .withFailureHandler(onSearchFailure)
                .getStudentData(stageSelect.value, gradeSelect.value, id);
        }

        function onSearchSuccess(response) {
            let r = document.getElementById('result');

            if (!response || response.status !== 'success' || response.error) {
                // Handle Error
                let msg = (response && response.error) ? response.error : "لم يتم العثور على بيانات الطالب";
                r.innerHTML = `<span style="color:#f87171; font-weight:bold;">${msg}</span>`;
                return;
            }

            // Populate Student Info
            document.getElementById('student-nid').textContent = response.nid;
            document.getElementById('resGrade').textContent = response.grade; // Or response.grade
            // We might want to update the Name/School if provided by backend
            if (response.studentName) {
                // Find the element for name. In current HTML it's static "محمد أحمد محمود", let's update it.
                // Looking at HTML, it's inside .info-group -> .info-value. 
                // We need to target specific elements. I will assume we need to add IDs to these elements or traverse.
                // For now, I'll update the static DOM structures if I can identify them, or just leave as is if no ID.
                // NOTE: The previous code didn't update name. I'll stick to 'student-nid' and 'resGrade' which have IDs.

                // Let's try to update name if we can find it structurally or add ID.
                // The first info-value is Name.
                const infoValues = document.querySelectorAll('.student-info .info-value');
                if (infoValues.length > 0) infoValues[0].textContent = response.studentName;
                if (infoValues.length > 3) infoValues[3].textContent = response.schoolName;
            }

            // Render Table
            renderResultTable(response.stage, response.grade, response);

            // Toggle visibility
            document.getElementById('searchCard').classList.add('hidden');
            document.getElementById('resultCard').classList.remove('hidden');

            // Clear loading
            r.innerHTML = '';
        }

        function onSearchFailure(error) {
            let r = document.getElementById('result');
            r.innerHTML = `<span style="color:#f87171; font-weight:bold;">خطأ في الاتصال: ${error.message}</span>`;
        }

        /* function goBack() removed */
    </script>

    <!-- Footer -->
    <footer>
        <span style="font-size: 1.3rem; font-weight: 900;">© جميع الحقوق محفوظة — برمجة: يوسف عماد كامل 2026</span>
        <div style="margin-top: 4px; font-size: 1rem; color: var(--accent-color);">
            إشراف: مس / ماجده — مستر / سيد
        </div>
    </footer>

</body>

</html>